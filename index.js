"use strict";
var async = require("async");
var Promise = require("bluebird");
var modbus_eastron_1 = require('modbus-eastron');
var rpj = require("request-promise-json");
var moment = require("moment-timezone");
var default_1 = (function () {
    function default_1(disps) {
        this.devices = disps;
        this.validTime = false;
    }
    default_1.prototype.loopStop = function () {
        if (this.loopVar) {
            clearInterval(this.loopVar);
        }
        else {
            console.error("not exists");
        }
    };
    default_1.prototype.loopStart = function (options) {
        var _this = this;
        if (!_this.loopVar) {
            console.log("starting");
            if (!options.interval)
                options.interval = 300000;
            function loopBoot() {
                _this.loopVar = setInterval(function () {
                    _this.data().then(function (answers) {
                        if (options.done) {
                            options.done(answers);
                        }
                    }).catch(function (err) {
                        console.warn(err);
                    });
                }, options.interval);
            }
            if (_this.checkTime && options.checkDate && _this.validTime) {
                loopBoot();
            }
            else {
                if (!_this.checkTime) {
                    _this.checkTime = true;
                    _this.checkDate();
                    console.warn("checkTime");
                    setTimeout(function () {
                        _this.loopStart(options);
                    }, 5000);
                }
                else {
                    console.warn("waiting for correct time");
                    setTimeout(function () {
                        _this.loopStart(options);
                    }, 3000);
                }
            }
        }
        else {
            console.error("exists");
        }
    };
    default_1.prototype.data = function () {
        var disps = this.devices;
        return new Promise(function (resolve, reject) {
            var answers = [];
            async.eachSeries(disps, function (iterator, cb) {
                modbus_eastron_1.default(iterator).then(function (a) {
                    a.active = true;
                    answers.push(a);
                    cb();
                }).catch(function (err) {
                    answers.push({
                        active: false,
                        _id: iterator.uid,
                        uid: iterator.uid,
                        unixTime: 0
                    });
                    console.error(err);
                    cb();
                });
            }, function (err) {
                if (err) {
                    console.log(err);
                    reject(err);
                }
                else {
                    resolve(answers);
                }
            });
        });
    };
    default_1.prototype.checkDate = function () {
        var that = this;
        function checkRemote() {
            rpj.get("https://io.kernel.online/date").then(function (date) {
                console.log(date);
                if (new Date().getTime() > (date.unixtime - 90000)) {
                    console.log("time is valid from now");
                    that.validTime = true;
                }
                else {
                    checkRemote();
                }
            }).catch(function (err) {
                console.log(err);
                checkRemote();
            });
        }
        checkRemote();
    };
    return default_1;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;

//# sourceMappingURL=data:application/json;base64,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QUFBO0lBQ04sQ0FBQztJQUNELDZCQUFTLEdBQVQ7UUFDSSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEI7WUFDSSxHQUFHLENBQUMsR0FBRyxDQUFDLCtCQUErQixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSTtnQkFFeEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFFbEIsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqRCxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLENBQUM7b0JBQ3RDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO2dCQUMxQixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLFdBQVcsRUFBRSxDQUFDO2dCQUNsQixDQUFDO1lBRUwsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRztnQkFDbEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakIsV0FBVyxFQUFFLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO1FBRUQsV0FBVyxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUNMLGdCQUFDO0FBQUQsQ0EvSEEsQUErSEMsSUFBQTtBQS9IRDsyQkErSEMsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzeW5jIGZyb20gXCJhc3luY1wiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcblxuaW1wb3J0IEVhc3Ryb24gZnJvbSAnbW9kYnVzLWVhc3Ryb24nO1xuXG5sZXQgcnBqID0gcmVxdWlyZShcInJlcXVlc3QtcHJvbWlzZS1qc29uXCIpO1xuXG5sZXQgbW9tZW50OiBhbnkgPSByZXF1aXJlKFwibW9tZW50LXRpbWV6b25lXCIpO1xuXG5pbnRlcmZhY2UgRWFzdHJvbkRldmljZSB7XG4gICAgZGV2Pzogc3RyaW5nO1xuICAgIGh1Yj86IHN0cmluZztcbiAgICBiYXVkOiBudW1iZXI7XG4gICAgaWQ6IG51bWJlcjtcbiAgICB1aWQ/OiBzdHJpbmc7XG4gICAgbW9kZWw6IHN0cmluZztcbn1cblxuXG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3Mge1xuICAgIGRldmljZXM6IEVhc3Ryb25EZXZpY2VbXTtcbiAgICB2YWxpZFRpbWU6IGJvb2xlYW47XG4gICAgY2hlY2tUaW1lOiBib29sZWFuO1xuICAgIGxvb3BUaW1lOiBudW1iZXI7XG4gICAgbG9vcFZhcjogYW55O1xuICAgIGxhc3Q6IGFueVxuXG4gICAgY29uc3RydWN0b3IoZGlzcHM6IEVhc3Ryb25EZXZpY2VbXSkge1xuICAgICAgICB0aGlzLmRldmljZXMgPSBkaXNwcztcbiAgICAgICAgdGhpcy52YWxpZFRpbWUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBsb29wU3RvcCgpIHtcbiAgICAgICAgaWYgKHRoaXMubG9vcFZhcikge1xuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmxvb3BWYXIpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwibm90IGV4aXN0c1wiKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgbG9vcFN0YXJ0KG9wdGlvbnM6IHsgaW50ZXJ2YWw/OiBudW1iZXI7IGNoZWNrRGF0ZT86IGJvb2xlYW4sIGRvbmU/OiBGdW5jdGlvbiB9KSB7XG5cbiAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzXG5cbiAgICAgICAgaWYgKCFfdGhpcy5sb29wVmFyKSB7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwic3RhcnRpbmdcIilcblxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLmludGVydmFsKSBvcHRpb25zLmludGVydmFsID0gMzAwMDAwO1xuXG4gICAgICAgICAgICBmdW5jdGlvbiBsb29wQm9vdCgpIHtcblxuICAgICAgICAgICAgICAgIF90aGlzLmxvb3BWYXIgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmRhdGEoKS50aGVuKGZ1bmN0aW9uIChhbnN3ZXJzOiBhbnlbXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZG9uZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuZG9uZShhbnN3ZXJzKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oZXJyKVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sIG9wdGlvbnMuaW50ZXJ2YWwpO1xuXG4gICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgaWYgKF90aGlzLmNoZWNrVGltZSAmJiBvcHRpb25zLmNoZWNrRGF0ZSAmJiBfdGhpcy52YWxpZFRpbWUpIHtcblxuICAgICAgICAgICAgICAgIGxvb3BCb290KClcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIGlmICghX3RoaXMuY2hlY2tUaW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNoZWNrVGltZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmNoZWNrRGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJjaGVja1RpbWVcIilcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5sb29wU3RhcnQob3B0aW9ucylcbiAgICAgICAgICAgICAgICAgICAgfSwgNTAwMClcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJ3YWl0aW5nIGZvciBjb3JyZWN0IHRpbWVcIilcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5sb29wU3RhcnQob3B0aW9ucylcbiAgICAgICAgICAgICAgICAgICAgfSwgMzAwMClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiZXhpc3RzXCIpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkYXRhKCkge1xuICAgICAgICBsZXQgZGlzcHMgPSB0aGlzLmRldmljZXNcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcblxuXG4gICAgICAgICAgICBjb25zdCBhbnN3ZXJzID0gW107XG5cbiAgICAgICAgICAgIGFzeW5jLmVhY2hTZXJpZXMoZGlzcHMsIGZ1bmN0aW9uIChpdGVyYXRvciwgY2IpIHtcblxuICAgICAgICAgICAgICAgIEVhc3Ryb24oaXRlcmF0b3IpLnRoZW4oKGE6IGFueSkgPT4geyAvLyBhY3RpdmUgZmxhZyBpcyBuZWVkZWRcbiAgICAgICAgICAgICAgICAgICAgYS5hY3RpdmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBhbnN3ZXJzLnB1c2goYSlcbiAgICAgICAgICAgICAgICAgICAgY2IoKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYW5zd2Vycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBfaWQ6IGl0ZXJhdG9yLnVpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVpZDogaXRlcmF0b3IudWlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdW5peFRpbWU6IDBcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgICAgICBjYigpXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYW5zd2VycylcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH1cbiAgICBjaGVja0RhdGUoKSB7XG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcbiAgICAgICAgZnVuY3Rpb24gY2hlY2tSZW1vdGUoKSB7XG4gICAgICAgICAgICBycGouZ2V0KFwiaHR0cHM6Ly9pby5rZXJuZWwub25saW5lL2RhdGVcIikudGhlbihmdW5jdGlvbiAoZGF0ZSkge1xuXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0ZSk7XG5cbiAgICAgICAgICAgICAgICBpZiAobmV3IERhdGUoKS5nZXRUaW1lKCkgPiAoZGF0ZS51bml4dGltZSAtIDkwMDAwKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInRpbWUgaXMgdmFsaWQgZnJvbSBub3dcIik7XG4gICAgICAgICAgICAgICAgICAgIHRoYXQudmFsaWRUaW1lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjaGVja1JlbW90ZSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgY2hlY2tSZW1vdGUoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY2hlY2tSZW1vdGUoKTtcbiAgICB9XG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
