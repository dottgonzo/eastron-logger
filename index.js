"use strict";
var async = require("async");
var Promise = require("bluebird");
var modbus_eastron_1 = require('modbus-eastron');
var rpj = require("request-promise-json");
var default_1 = (function () {
    function default_1(disps) {
        if (!disps) {
            throw Error("no disps");
        }
        else {
            if (disps[0] && disps[0].baud) {
                this.devices = disps;
            }
            else {
                var d = [disps];
                this.devices = d;
                if (disps[0] && disps[0].baud)
                    throw Error("malformed disps");
            }
        }
        this.validTime = false;
    }
    default_1.prototype.loopStop = function () {
        if (this.loopVar) {
            clearInterval(this.loopVar);
        }
        else {
            console.error("not exists");
        }
    };
    default_1.prototype.loopStart = function (options) {
        var _this = this;
        if (!_this.loopVar) {
            console.log("starting");
            if (!options.interval)
                options.interval = 300000;
            function loopBoot() {
                _this.loopVar = setInterval(function () {
                    _this.data().then(function (answers) {
                        if (options.done) {
                            options.done(answers);
                        }
                    }).catch(function (err) {
                        console.warn(err);
                    });
                }, options.interval);
            }
            if (_this.checkTime && options.checkDate && _this.validTime) {
                loopBoot();
            }
            else {
                if (!_this.checkTime) {
                    _this.checkTime = true;
                    _this.checkDate();
                    console.warn("checkTime");
                    setTimeout(function () {
                        _this.loopStart(options);
                    }, 5000);
                }
                else {
                    console.warn("waiting for correct time");
                    setTimeout(function () {
                        _this.loopStart(options);
                    }, 3000);
                }
            }
        }
        else {
            console.error("exists");
        }
    };
    default_1.prototype.data = function () {
        var disps = this.devices;
        var _this = this;
        return new Promise(function (resolve, reject) {
            var answers = [];
            async.eachSeries(disps, function (iterator, cb) {
                modbus_eastron_1.default(iterator).then(function (a) {
                    a.working = true;
                    answers.push(a);
                    cb();
                }).catch(function (err) {
                    var cname = 'data';
                    if (iterator.className)
                        cname = iterator.className;
                    answers.push({
                        working: false,
                        _id: cname + '_' + iterator.uid + '_' + new Date().getTime(),
                        uid: iterator.uid,
                        unixTime: new Date().getTime()
                    });
                    console.error('err', err);
                    cb();
                });
            }, function (err) {
                if (err) {
                    console.log(err);
                    reject(err);
                }
                else {
                    resolve(answers);
                }
            });
        });
    };
    default_1.prototype.checkDate = function () {
        var that = this;
        function checkRemote() {
            rpj.get("https://io.kernel.online/date").then(function (date) {
                console.log(date);
                if (new Date().getTime() > (date.unixtime - 90000)) {
                    console.log("time is valid from now");
                    that.validTime = true;
                }
                else {
                    checkRemote();
                }
            }).catch(function (err) {
                console.log(err);
                checkRemote();
            });
        }
        checkRemote();
    };
    return default_1;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;

//# sourceMappingURL=data:application/json;base64,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S0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqRCxPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLENBQUM7b0JBQ3RDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO2dCQUMxQixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLFdBQVcsRUFBRSxDQUFDO2dCQUNsQixDQUFDO1lBRUwsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRztnQkFDbEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakIsV0FBVyxFQUFFLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO1FBRUQsV0FBVyxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUNMLGdCQUFDO0FBQUQsQ0FqSkEsQUFpSkMsSUFBQTtBQWpKRDsyQkFpSkMsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzeW5jIGZyb20gXCJhc3luY1wiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcblxuaW1wb3J0IEVhc3Ryb24gZnJvbSAnbW9kYnVzLWVhc3Ryb24nO1xuXG5sZXQgcnBqID0gcmVxdWlyZShcInJlcXVlc3QtcHJvbWlzZS1qc29uXCIpO1xuXG5cblxuaW50ZXJmYWNlIEVhc3Ryb25EZXZpY2Uge1xuICAgIGRldj86IHN0cmluZztcbiAgICBodWI/OiBzdHJpbmc7XG4gICAgYmF1ZDogbnVtYmVyO1xuICAgIGlkOiBudW1iZXI7XG4gICAgdWlkPzogc3RyaW5nO1xuICAgIG1vZGVsOiBzdHJpbmc7XG4gICAgY2xhc3NOYW1lPzogc3RyaW5nO1xufVxuXG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3Mge1xuICAgIGRldmljZXM6IEVhc3Ryb25EZXZpY2VbXTtcbiAgICB2YWxpZFRpbWU6IGJvb2xlYW47XG4gICAgY2hlY2tUaW1lOiBib29sZWFuO1xuICAgIGxvb3BUaW1lOiBudW1iZXI7XG4gICAgbG9vcFZhcjogYW55O1xuICAgIGxhc3Q6IGFueVxuXG4gICAgY29uc3RydWN0b3IoZGlzcHM6IEVhc3Ryb25EZXZpY2VbXSkge1xuXG5cbiAgICAgICAgaWYgKCFkaXNwcykge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJubyBkaXNwc1wiKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGRpc3BzWzBdICYmIGRpc3BzWzBdLmJhdWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRldmljZXMgPSBkaXNwcztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGV0IGQ6IGFueSA9IFtkaXNwc11cbiAgICAgICAgICAgICAgICB0aGlzLmRldmljZXMgPSA8RWFzdHJvbkRldmljZVtdPmQ7XG4gICAgICAgICAgICAgICAgaWYgKGRpc3BzWzBdICYmIGRpc3BzWzBdLmJhdWQpIHRocm93IEVycm9yKFwibWFsZm9ybWVkIGRpc3BzXCIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuXG4gICAgICAgIHRoaXMudmFsaWRUaW1lID0gZmFsc2U7XG4gICAgfVxuXG4gICAgbG9vcFN0b3AoKSB7XG4gICAgICAgIGlmICh0aGlzLmxvb3BWYXIpIHtcbiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5sb29wVmFyKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIm5vdCBleGlzdHNcIilcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGxvb3BTdGFydChvcHRpb25zOiB7IGludGVydmFsPzogbnVtYmVyOyBjaGVja0RhdGU/OiBib29sZWFuLCBkb25lPzogRnVuY3Rpb24gfSkge1xuXG4gICAgICAgIGNvbnN0IF90aGlzID0gdGhpc1xuXG4gICAgICAgIGlmICghX3RoaXMubG9vcFZhcikge1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInN0YXJ0aW5nXCIpXG5cbiAgICAgICAgICAgIGlmICghb3B0aW9ucy5pbnRlcnZhbCkgb3B0aW9ucy5pbnRlcnZhbCA9IDMwMDAwMDtcblxuICAgICAgICAgICAgZnVuY3Rpb24gbG9vcEJvb3QoKSB7XG5cbiAgICAgICAgICAgICAgICBfdGhpcy5sb29wVmFyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5kYXRhKCkudGhlbihmdW5jdGlvbiAoYW5zd2VyczogYW55W10pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmRvbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmRvbmUoYW5zd2VycylcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGVycilcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LCBvcHRpb25zLmludGVydmFsKTtcblxuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIGlmIChfdGhpcy5jaGVja1RpbWUgJiYgb3B0aW9ucy5jaGVja0RhdGUgJiYgX3RoaXMudmFsaWRUaW1lKSB7XG5cbiAgICAgICAgICAgICAgICBsb29wQm9vdCgpXG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoIV90aGlzLmNoZWNrVGltZSkge1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jaGVja1RpbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5jaGVja0RhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiY2hlY2tUaW1lXCIpXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubG9vcFN0YXJ0KG9wdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgIH0sIDUwMDApXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwid2FpdGluZyBmb3IgY29ycmVjdCB0aW1lXCIpXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubG9vcFN0YXJ0KG9wdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgIH0sIDMwMDApXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcImV4aXN0c1wiKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZGF0YSgpIHtcbiAgICAgICAgbGV0IGRpc3BzID0gdGhpcy5kZXZpY2VzXG4gICAgICAgIGxldCBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG5cblxuICAgICAgICAgICAgY29uc3QgYW5zd2VycyA9IFtdO1xuXG4gICAgICAgICAgICBhc3luYy5lYWNoU2VyaWVzKGRpc3BzLCBmdW5jdGlvbiAoaXRlcmF0b3IsIGNiKSB7XG5cbiAgICAgICAgICAgICAgICBFYXN0cm9uKGl0ZXJhdG9yKS50aGVuKChhOiBhbnkpID0+IHsgLy8gYWN0aXZlIGZsYWcgaXMgbmVlZGVkXG4gICAgICAgICAgICAgICAgICAgIGEud29ya2luZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGFuc3dlcnMucHVzaChhKVxuICAgICAgICAgICAgICAgICAgICBjYigpXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgY25hbWUgPSAnZGF0YSc7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvci5jbGFzc05hbWUpIGNuYW1lID0gaXRlcmF0b3IuY2xhc3NOYW1lO1xuXG4gICAgICAgICAgICAgICAgICAgIGFuc3dlcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICB3b3JraW5nOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIF9pZDogY25hbWUgKyAnXycgKyBpdGVyYXRvci51aWQgKyAnXycgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVpZDogaXRlcmF0b3IudWlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdW5peFRpbWU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2VycicsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIGNiKClcbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhbnN3ZXJzKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfVxuICAgIGNoZWNrRGF0ZSgpIHtcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xuICAgICAgICBmdW5jdGlvbiBjaGVja1JlbW90ZSgpIHtcbiAgICAgICAgICAgIHJwai5nZXQoXCJodHRwczovL2lvLmtlcm5lbC5vbmxpbmUvZGF0ZVwiKS50aGVuKGZ1bmN0aW9uIChkYXRlKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRlKTtcblxuICAgICAgICAgICAgICAgIGlmIChuZXcgRGF0ZSgpLmdldFRpbWUoKSA+IChkYXRlLnVuaXh0aW1lIC0gOTAwMDApKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidGltZSBpcyB2YWxpZCBmcm9tIG5vd1wiKTtcbiAgICAgICAgICAgICAgICAgICAgdGhhdC52YWxpZFRpbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrUmVtb3RlKCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICBjaGVja1JlbW90ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjaGVja1JlbW90ZSgpO1xuICAgIH1cbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
