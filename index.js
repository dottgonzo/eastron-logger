"use strict";
var async = require("async");
var Promise = require("bluebird");
var modbus_eastron_1 = require('modbus-eastron');
var rpj = require("request-promise-json");
var default_1 = (function () {
    function default_1(disps) {
        if (!disps) {
            throw Error("no disps");
        }
        else {
            if (disps[0] && disps[0].baud) {
                this.devices = disps;
            }
            else {
                var d = [disps];
                this.devices = d;
                if (disps[0] && disps[0].baud)
                    throw Error("malformed disps");
            }
        }
        this.validTime = false;
    }
    default_1.prototype.loopStop = function () {
        if (this.loopVar) {
            clearInterval(this.loopVar);
        }
        else {
            console.error("not exists");
        }
    };
    default_1.prototype.loopStart = function (options) {
        var _this = this;
        if (!_this.loopVar) {
            console.log("starting");
            if (!options.interval)
                options.interval = 300000;
            function loopBoot() {
                _this.loopVar = setInterval(function () {
                    _this.data().then(function (answers) {
                        if (options.done) {
                            options.done(answers);
                        }
                    }).catch(function (err) {
                        console.warn(err);
                    });
                }, options.interval);
            }
            if (_this.checkTime && options.checkDate && _this.validTime) {
                loopBoot();
            }
            else {
                if (!_this.checkTime) {
                    _this.checkTime = true;
                    _this.checkDate();
                    console.warn("checkTime");
                    setTimeout(function () {
                        _this.loopStart(options);
                    }, 5000);
                }
                else {
                    console.warn("waiting for correct time");
                    setTimeout(function () {
                        _this.loopStart(options);
                    }, 3000);
                }
            }
        }
        else {
            console.error("exists");
        }
    };
    default_1.prototype.data = function () {
        var disps = this.devices;
        return new Promise(function (resolve, reject) {
            var answers = [];
            async.eachSeries(disps, function (iterator, cb) {
                modbus_eastron_1.default(iterator).then(function (a) {
                    a.working = true;
                    answers.push(a);
                    cb();
                }).catch(function (err) {
                    answers.push({
                        working: false,
                        _id: iterator.uid,
                        uid: iterator.uid,
                        unixTime: 0
                    });
                    console.error('err', err);
                    cb();
                });
            }, function (err) {
                if (err) {
                    console.log(err);
                    reject(err);
                }
                else {
                    resolve(answers);
                }
            });
        });
    };
    default_1.prototype.checkDate = function () {
        var that = this;
        function checkRemote() {
            rpj.get("https://io.kernel.online/date").then(function (date) {
                console.log(date);
                if (new Date().getTime() > (date.unixtime - 90000)) {
                    console.log("time is valid from now");
                    that.validTime = true;
                }
                else {
                    checkRemote();
                }
            }).catch(function (err) {
                console.log(err);
                checkRemote();
            });
        }
        checkRemote();
    };
    return default_1;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;

//# sourceMappingURL=data:application/json;base64,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LENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pCLFdBQVcsRUFBRSxDQUFDO1lBQ2xCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztRQUVELFdBQVcsRUFBRSxDQUFDO0lBQ2xCLENBQUM7SUFDTCxnQkFBQztBQUFELENBN0lBLEFBNklDLElBQUE7QUE3SUQ7MkJBNklDLENBQUEiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBhc3luYyBmcm9tIFwiYXN5bmNcIjtcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5cbmltcG9ydCBFYXN0cm9uIGZyb20gJ21vZGJ1cy1lYXN0cm9uJztcblxubGV0IHJwaiA9IHJlcXVpcmUoXCJyZXF1ZXN0LXByb21pc2UtanNvblwiKTtcblxuXG5cbmludGVyZmFjZSBFYXN0cm9uRGV2aWNlIHtcbiAgICBkZXY/OiBzdHJpbmc7XG4gICAgaHViPzogc3RyaW5nO1xuICAgIGJhdWQ6IG51bWJlcjtcbiAgICBpZDogbnVtYmVyO1xuICAgIHVpZD86IHN0cmluZztcbiAgICBtb2RlbDogc3RyaW5nO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIHtcbiAgICBkZXZpY2VzOiBFYXN0cm9uRGV2aWNlW107XG4gICAgdmFsaWRUaW1lOiBib29sZWFuO1xuICAgIGNoZWNrVGltZTogYm9vbGVhbjtcbiAgICBsb29wVGltZTogbnVtYmVyO1xuICAgIGxvb3BWYXI6IGFueTtcbiAgICBsYXN0OiBhbnlcblxuICAgIGNvbnN0cnVjdG9yKGRpc3BzOiBFYXN0cm9uRGV2aWNlW10pIHtcblxuXG4gICAgICAgIGlmICghZGlzcHMpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFwibm8gZGlzcHNcIilcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChkaXNwc1swXSAmJiBkaXNwc1swXS5iYXVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZXZpY2VzID0gZGlzcHM7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxldCBkOiBhbnkgPSBbZGlzcHNdXG4gICAgICAgICAgICAgICAgdGhpcy5kZXZpY2VzID0gPEVhc3Ryb25EZXZpY2VbXT5kO1xuICAgICAgICAgICAgICAgIGlmIChkaXNwc1swXSAmJiBkaXNwc1swXS5iYXVkKSB0aHJvdyBFcnJvcihcIm1hbGZvcm1lZCBkaXNwc1wiKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cblxuICAgICAgICB0aGlzLnZhbGlkVGltZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIGxvb3BTdG9wKCkge1xuICAgICAgICBpZiAodGhpcy5sb29wVmFyKSB7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMubG9vcFZhcilcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJub3QgZXhpc3RzXCIpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsb29wU3RhcnQob3B0aW9uczogeyBpbnRlcnZhbD86IG51bWJlcjsgY2hlY2tEYXRlPzogYm9vbGVhbiwgZG9uZT86IEZ1bmN0aW9uIH0pIHtcblxuICAgICAgICBjb25zdCBfdGhpcyA9IHRoaXNcblxuICAgICAgICBpZiAoIV90aGlzLmxvb3BWYXIpIHtcblxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJzdGFydGluZ1wiKVxuXG4gICAgICAgICAgICBpZiAoIW9wdGlvbnMuaW50ZXJ2YWwpIG9wdGlvbnMuaW50ZXJ2YWwgPSAzMDAwMDA7XG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIGxvb3BCb290KCkge1xuXG4gICAgICAgICAgICAgICAgX3RoaXMubG9vcFZhciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuZGF0YSgpLnRoZW4oZnVuY3Rpb24gKGFuc3dlcnM6IGFueVtdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kb25lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5kb25lKGFuc3dlcnMpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihlcnIpXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSwgb3B0aW9ucy5pbnRlcnZhbCk7XG5cbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICBpZiAoX3RoaXMuY2hlY2tUaW1lICYmIG9wdGlvbnMuY2hlY2tEYXRlICYmIF90aGlzLnZhbGlkVGltZSkge1xuXG4gICAgICAgICAgICAgICAgbG9vcEJvb3QoKVxuXG4gICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgaWYgKCFfdGhpcy5jaGVja1RpbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2hlY2tUaW1lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY2hlY2tEYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcImNoZWNrVGltZVwiKVxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmxvb3BTdGFydChvcHRpb25zKVxuICAgICAgICAgICAgICAgICAgICB9LCA1MDAwKVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcIndhaXRpbmcgZm9yIGNvcnJlY3QgdGltZVwiKVxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmxvb3BTdGFydChvcHRpb25zKVxuICAgICAgICAgICAgICAgICAgICB9LCAzMDAwKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJleGlzdHNcIilcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRhdGEoKSB7XG4gICAgICAgIGxldCBkaXNwcyA9IHRoaXMuZGV2aWNlc1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuXG5cbiAgICAgICAgICAgIGNvbnN0IGFuc3dlcnMgPSBbXTtcblxuICAgICAgICAgICAgYXN5bmMuZWFjaFNlcmllcyhkaXNwcywgZnVuY3Rpb24gKGl0ZXJhdG9yLCBjYikge1xuXG4gICAgICAgICAgICAgICAgRWFzdHJvbihpdGVyYXRvcikudGhlbigoYTogYW55KSA9PiB7IC8vIGFjdGl2ZSBmbGFnIGlzIG5lZWRlZFxuICAgICAgICAgICAgICAgICAgICBhLndvcmtpbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBhbnN3ZXJzLnB1c2goYSlcbiAgICAgICAgICAgICAgICAgICAgY2IoKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYW5zd2Vycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtpbmc6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgX2lkOiBpdGVyYXRvci51aWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB1aWQ6IGl0ZXJhdG9yLnVpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVuaXhUaW1lOiAwXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2VycicsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIGNiKClcbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhbnN3ZXJzKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfVxuICAgIGNoZWNrRGF0ZSgpIHtcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xuICAgICAgICBmdW5jdGlvbiBjaGVja1JlbW90ZSgpIHtcbiAgICAgICAgICAgIHJwai5nZXQoXCJodHRwczovL2lvLmtlcm5lbC5vbmxpbmUvZGF0ZVwiKS50aGVuKGZ1bmN0aW9uIChkYXRlKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRlKTtcblxuICAgICAgICAgICAgICAgIGlmIChuZXcgRGF0ZSgpLmdldFRpbWUoKSA+IChkYXRlLnVuaXh0aW1lIC0gOTAwMDApKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidGltZSBpcyB2YWxpZCBmcm9tIG5vd1wiKTtcbiAgICAgICAgICAgICAgICAgICAgdGhhdC52YWxpZFRpbWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrUmVtb3RlKCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICBjaGVja1JlbW90ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjaGVja1JlbW90ZSgpO1xuICAgIH1cbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
